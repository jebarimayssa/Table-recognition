{% load static %}

<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>Turn_The_Tables</title>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700&display=swap" rel="stylesheet">
  <link href="{% static 'tables/css/homestyle.css' %}" rel="stylesheet" />
  <!--Jquery-->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"
    integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>

</head>

<body>
<!--
  <nav>
    <div class="logo">
      <span id="title"><a href="{{% url 'landing' %}">Turn-the-Tables</a></span>
    </div>
-->

  </nav>

  <main>
    <div class="centerpage">
      <div><span class="sectionHeader">Extract your Data</span></div>
      <div class="animation"><img src="{% static 'tables/images/float-illustration.gif' %}" alt="img">
      </div>
      <div class="buttons">
        <form id="uploadform" method="POST" enctype="multipart/form-data" action="">
          {% csrf_token %}

          <div>
            <input type="file" name="photo" id="upform" accept="image/*" hidden="hidden" />
            <button type="button" id="custom-button">CHOOSE AN IMAGE</button>
            <span id="custom-text">No file chosen, yet.</span>
          </div>

          <input type="button" id="file_button" class="myButton myButton:hover myButton:active" value="Submit">

        </form>
      </div>
    </div>


    <div id="result">
      <h3>RESULTS</h3>
      <img class="loadAnim" src="{% static 'tables/images/Spin-1s-200px.svg' %}" alt="svg">
      <div id="table" >

        <!-- table will come here -->

      </div>
      <div class="buttons">

        <a href="{% url 'downloadX' %}">
          <button id="xlsx" class="myButton myButton:hover myButton:active">Download <span
              id="xlsx">xlsx</span></button>
        </a>
        <a href="{% url 'downloadC' %}">
          <button id="csv" class="myButton myButton:hover myButton:active">Download csv</button>
        </a>

           <a href="{% url 'exportJson' %}">
          <button id="json" class="myButton myButton:hover myButton:active">export Json</button>
        </a>

       <button class="myButton myButton:hover myButton:active" id="btn">Export-Updated</button>




      </div>


    </div>


  </main>

  <script>
    function onClickMenu() {
      document.getElementById("menu").classList.toggle("change");
      document.getElementById("nav").classList.toggle("change");

      document.getElementById("menu-bg").classList.toggle("change-bg");
    }
  </script>

  <script>
    const realFileBtn = document.getElementById("upform");
    const customBtn = document.getElementById("custom-button");
    const customTxt = document.getElementById("custom-text");

    customBtn.addEventListener("click", function () {
      realFileBtn.click();
    });

    realFileBtn.addEventListener("change", function () {
      if (realFileBtn.value) {
        customTxt.innerHTML = realFileBtn.value.match(
          /[\/\\]([\w\d\s\.\-\(\)]+)$/
        )[1];
      } else {
        customTxt.innerHTML = "No file chosen, yet.";
      }
    });

  </script>

  <script>
    $(".loadAnim").css("display", "none");
    let jsObj;
    $(function () {
      $('#file_button').click(function () {
        $(".loadAnim").css("display", "block");
        var form_data = new FormData($('#uploadform')[0]);
        var elmnt = document.getElementById("result");
        elmnt.scrollIntoView();
        $.ajax({
          type: 'POST',
          url: '/process',
          data: form_data,
          contentType: false,
          cache: false,
          processData: false,
          success: function (data) {
            jsObj = JSON.parse(data)
            console.log(jsObj)

            // Task 1 : Loop thr
            var rowsL = Object.keys(jsObj);
            var colsL = Object.keys(jsObj[0]);
            let table = document.createElement("table")
            let tr = table.insertRow(-1)
            for (var i = 0; i < rowsL.length; i++) {
              var th = document.createElement("th");      // TABLE HEADER.
              th.innerHTML = "<div contenteditable>"+ jsObj[i][0]+ "</div>";
              th.innerHTML = "";
              tr.appendChild(th);
            }

            // ADD JSON DATA TO THE TABLE AS ROWS.
            for (var j = 1; j < colsL.length; j++) {
                tr = table.insertRow(-1)

                for (var i = 0; i < rowsL.length; i++) {
                    var tabCell = tr.insertCell(-1);

                    tabCell.innerHTML = "<div contenteditable>" + jsObj [i] [j] + "</div>";

                    if(tabCell.textContent.match(/^(0?[1-9]|[12][0-9]|3[01])[\/\-](0?[1-9]|1[012])[\/\-]\d{4}$/))
                    {
                        console.log("Date valid");
                        tabCell.innerHTML = "<input type='date'>"
                    }
                       //tabCell.value = jsObj [i] [j];
                        else
                    {
                             console.log("Date invalid");
                    }



                }

            }


             var max=0;
             //var element=document.getElementById('table');
             var totalRowCount = table.rows.length;
        // this algorithmn counts the max number of nonempty columns
            for(var i=0 ; i<totalRowCount;i++)
            {
                var numCols=0;
                for(var j=0;j<table.rows[i].cells.length;j++)
                {
                    if(table.rows[i].cells[j].textContent!='')
                        ++numCols;
                    }

                    if(numCols>max)
                    max=numCols;
                    }

                    console.log(max);

                // now we remove the rows which have nonempty rows less than max
                for(var i=0;i<table.rows.length;i++)
                {
                    var numCols=0;
                        for(var j=0;j<table.rows[i].cells.length;j++)
                        {
                        if(table.rows[i].cells[j].textContent!='')
                            ++numCols;
                        }

                        if(numCols!=max)
                        //table.parentNode.removeChild(table);
                        table.rows[i].innerHTML="";

                        else
                        break; // ensures that only the header is removed
                        }



            $(".loadAnim").css("display", "none");
            // FINALLY ADD THE NEWLY CREATED TABLE WITH JSON DATA TO A CONTAINER.
            var divContainer = document.getElementById("table");
            divContainer.innerHTML = "";
            divContainer.appendChild(table);
            $('table').css('border-collapse', 'collapse');
            $('table').css('margin', '25px 0');
            $('table').css('font-size', '0.9em');
            $('table').css('min-width', '400px');
            $('table').css('border-radius', '5px 5px 0 0');
            $('table').css('overflow', 'hidden');

            $('table th').css('background-color', 'green');
            $('table th').css('background-color', 'green');
            $('table th').css('color', 'white');
            $('table th').css('text-align', 'left');
            $('table th').css('font-weight', 'bold');

            $('table th').css('padding', '12px 15px');
            $('table td').css('padding', '12px 15px');

            $('table tr').css('border-bottom', '1px solid #dddddd');
            $('table tr:last-of-type').css('border-bottom', '2px solid green');


          },
        })
      })
    })




  /*  function deleteMoreRows(tableID) {

    var table = document.getElementById(tableID);
    var rowCount = table.rows.length;
    var selectedRows = getCheckedBoxes();

    selectedRows.forEach(function(currentValue) {
      deleteRowByCheckboxId(currentValue.id);
    });
}

function getRowId() {
  rowId += 1;
  return rowId;
}


function getRowIdFromElement($el) {
    return $el.id.split('delete')[1];
}

//ref: http://stackoverflow.com/questions/8563240/how-to-get-all-checked-checkboxes
function getCheckedBoxes() {
  var inputs = document.getElementsByTagName("input");
  var checkboxesChecked = [];

  // loop over them all
  for (var i=0; i < inputs.length; i++) {
     // And stick the checked ones onto an array...
     if (inputs[i].checked) {
        checkboxesChecked.push(inputs[i]);
     }
  }

  // Return the array if it is non-empty, or null
  return checkboxesChecked.length > 0 ? checkboxesChecked : null;
}

//ref: http://stackoverflow.com/questions/4967223/delete-a-row-from-a-table-by-id
function deleteRowByCheckboxId(CheckboxId) {
    var checkbox = document.getElementById(CheckboxId);
    var row = checkbox.parentNode.parentNode;                //box, cell, row, table
    var table = row.parentNode;

    while ( table && table.tagName != 'TABLE' )
        table = table.parentNode;
    if (!table) return;
    table.deleteRow(row.rowIndex);
}




*/
  </script>







</body>

</html>